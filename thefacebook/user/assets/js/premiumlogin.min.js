jQuery(document).ready(function($) {
	
	//upload using iframe
	$('.crop_upload input').on('change', function(event) {
		if($(this).val())
			PLS.Upload();
	});


	//AJAX
	$('.ajaxform').on('submit', function(event) {
		event.preventDefault();

		var form = $(this);
			formData = form.serializeArray(),
			submit = form.find('[type="submit"]'),
			action = form.find('[name=action]').val(),
			alert = form.find('.message-box');

		submit.prop('disabled', true);
		PLS.Alert(alert, 2, 'Loading ...');
		
		$.ajax({
			url: PLS_config.ajax_url,
			type: 'POST',
			dataType: 'json',
			data: formData,
		})
		.done(function(response) {
			if(response.success)
			{
				if(action == 'login')
					window.location.reload();
				else 
					PLS.Alert(alert, 1, response.message);

				if(action == 'settings_crop')
				{
					$('.avatar').attr('src', response.data.avatar);
					PLS.Alert($('.crop_form .message-box'), -1, "");
				}
				if(action == 'admin_add' || action == 'signup')
					PLS.ClearForm();

				if(action == 'settings_general')
					$('.username').text(response.data.username);
			}
			else
			{
				PLS.Alert(alert, 0, response.message);
				if(action == 'settings_general' || action == 'admin_edit')
				{
					form.find('[name=email]').val(response.data.email);
					form.find('[name=username]').val(response.data.username);
				}
			}
		})
		.fail(function(response) {
			PLS.Alert(alert, 0, 'Ajax response error.');
		})
		.always(function() {
			form.find('[type="password"]').val('');
			submit.prop('disabled', false);
			if(action == 'settings_crop')
				PLS.ResetUpload();

			if(typeof Recaptcha == 'object' && form.find('.recaptcha').length) 
				Recaptcha.reload();
		})
	});
});


var PLS = {

	Alert: function(element, type, message) 
	{
		if(typeof message === 'string')
			message = [message];

		element.html('').removeClass().addClass('message-box');
		if(type != -1)
		{
			element.append('<ul></ul>');
			$.each(message, function(index, val) {element.find('ul').append('<li>' + val + '</li>');});
		
			//style your message box by adding classes to the .mesage-box element
			//type = -1 => close message
			//type = 0 => error
			//type = 1 => success
			//type = 1 => warning/loading state

			// Eg:
			// var message_class = (type == 0) ? 'alert' : (type == 1) ? 'success' : (type == 2) ? 'warning' : '';
			// element.addClass(message_class); 
		}
	},

	ClearForm: function()
	{
		$('input')
		  .not(':button, :submit, :reset, :hidden')
		  .val('')
		  .removeAttr('checked');
	},

	//Iframe Upload function
	Upload: function()
	{
		PLS.ResetUpload();
		var iframe = $('<iframe class="upload_element" name="upload_frame" style="display:none;"></iframe>'),
			action = $('<input type="hidden" name="action" value="settings_upload">'),
			form = $('<form class="upload_element" action=' + PLS_config.ajax_url + ' method="POST" enctype="multipart/form-data" target="upload_frame" style="display:none;"></form>'),
			upload_field = $('.crop_upload input').clone(),
			alert = $('.crop_form .message-box');

		upload_field.on('change', function(event) {
			if($(this).val())
				PLS.Upload();
		});

		$('body').append(form.append(action).append($('.crop_upload input'))).append(iframe);
		form.trigger('submit');
		PLS.Alert(alert, 2, 'Uploading...')

		iframe.on('load', function(event) {
			if($(this).contents().find('body').html())
			{
				try{var response = $.parseJSON($(this).contents().find('body').html());}catch(e){}
				if(response)
				{
					if(!response.success)
					{
						PLS.Alert(alert, 0, response.message);
					}
					else
					{
						var img = $('<img src=' + response.data.avatar + ' style="width:100%;">');
						$('.crop_image').append(img);
						var x = new Image();
						x.src = img.attr('src');
						x.onload = function(){
							img.Jcrop({aspectRatio: 1, bgColor: 'white', bgOpacity: 0.3, trueSize: [x.width,x.height], onSelect: PLS.UpdateCoords});
						}
						$('.crop_save').attr('disabled', false);
						$('.crop_save').show();
						PLS.Alert(alert, -1, "");
					}
				}
				else
					PLS.Alert(alert, 0, 'Invalid JSON response!');
				$('.crop_upload').append(upload_field);
				$('.upload_element').remove();
				
			}
		});
	},

	//helper function for reseting the upload modal
	ResetUpload: function()
	{
		$('.crop_image').html('');
		$('.crop_form .message-box').html('');
		$('.crop_save').attr('disabled', true);
		$('.crop_save').hide();
		$('.upload_element').remove();
		PLS.ResetCoords();
	},

	//Jcrop helper function for crop coords
	UpdateCoords: function(c)
	{
		$('#x').val(c.x);
	    $('#y').val(c.y);
	    $('#w').val(c.w);
	    $('#h').val(c.h);
	},

	//Jcrop helper function for reseting crop coords
	ResetCoords: function()
	{
		$('#x').val('');
	    $('#y').val('');
	    $('#w').val('');
	    $('#h').val('');
	},
};